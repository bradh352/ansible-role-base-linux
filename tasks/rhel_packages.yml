---
- name: Install Rocky Linux repo files
  template:
    src: "rocky/{{ item }}.j2"
    dest: "/etc/yum.repos.d/{{ item }}"
    owner: root
    mode: "644"
  with_items:
    - "rocky.repo"
    - "rocky-addons.repo"
    - "rocky-devel.repo"
    - "rocky-extras.repo"
  when: ansible_distribution == "Rocky"

- name: ensure EPEL release is not installed as we use our own repo files
  dnf:
    name: "epel-release"
    state: absent

- name: Install EPEL repo files
  template:
    src: "epel/{{ item }}.j2"
    dest: "/etc/yum.repos.d/{{ item }}"
    owner: root
    mode: "644"
  with_items:
    - "epel.repo"
    - "epel-testing.repo"

- name: Install EPEL keys
  copy:
    src: "{{ item }}"
    dest: "/etc/pki/rpm-gpg/{{ item }}"
    owner: root
    mode: "644"
  with_items:
    - "RPM-GPG-KEY-EPEL-10"

- name: upgrade all packages to the latest versions
  dnf:
    name: "*"
    state: latest
    update_cache: true
  ignore_errors: false
  when: not skip_updates|default(false)

- name: install base build packages for RHEL-like systems
  dnf:
    name: ["wget", "openssh-clients", "chrony", "acpid", "nano", "nc", "bzip2",
           "dnf-utils", "rsyslog", "tar", "unzip", "python3-policycoreutils",
           "fail2ban", "firewalld", "selinux-policy-epel-targeted" ] # "exim" not in RedHat 10?
    state: installed
